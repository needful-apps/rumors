stages:          
  - build
  - test
  - package
  - deploy
  - release

build-job:      
  script:
    - ls
    - echo "Compiling the code..."
    - echo "Compile complete."

unit-test-job:   
  stage: test    
  script:
    - echo "Running unit tests... This will take about 60 seconds."
    - sleep 1
    - echo "Code coverage is 90%"

lint-test-job:   # This job also runs in the test stage.
  stage: test    # It can run at the same time as unit-test-job (in parallel).
  script:
    - echo "Linting code... This will take about 10 seconds."
    - sleep 1
    - echo "No lint issues found."

package-content-job:   
  stage: package
  script:
    - echo "Packaging all *.htm* files into content.zip"
    - zip -r content.zip *.htm*
  artifacts:
    paths:
      - content.zip   
  only:
    - tags

create-release-job:
  stage: release
  script:
    - echo "Creating a new release and attaching the artifact for project ${CI_PROJECT_ID}"
    - RELEASE_URL="https://gitlab.needful-apps.de/api/v4/projects/${CI_PROJECT_ID}/releases"
    - echo "Release url is $RELEASE_URL"
    - CREATE='--location "$RELEASE_URL" --header "$R_TOKEN" --header "Content-Type:application/json" --data "{\"name\":\"New release\", \"tag_name\":\"1.25.32\", \"description\"":\"Super nice release\", \"assets":\{ \"links\":[{ \"name\":\"hoge\", \"url\":\"https://google.com\",\"direct_asset_path\":\"/binaries/linux-amd64\", \"link_type\":\"other\" } ] } }''
    - echo $CREATE
  only:
    - tags

get-new-version-job:   
  stage: deploy
  only:
    - main
  except:
    - tags
  script:
    - echo "Fetching newest version..."
    - |
      response=$(curl -s -X GET "https://needful-apps.de:8080/nextversion?app_id=4&major=1&minor=25" \
        -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Mjc2MDg2MTQsImlzcyI6InBhdGNocGlsb3QiLCJzdWIiOiJoYWJpY2h0c3dhbGQiLCJyb2xlIjp7ImlkIjoxLCJuYW1lIjoiYWRtaW4ifX0.i_1iNqdgaIcBa9cuUQnvqNR6lKZMEWpBwg5lh2SxffQ")
      version=$(echo $response | jq -r '.version')
      echo "Fetched version: $version"
    - echo "Tagging current commit with version $version"
    - git tag "$version"
    - git push https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.needful-apps.de/Schulung/rumors.git "$version"
    - echo "Deploying application..."
    - curl -X POST "http://automation.needful-apps.de/git-pull"
    - echo "Application successfully deployed."
    - echo "Informing version service with new version $version"
    - |
      curl -X POST "https://needful-apps.de:8080/version" \
        -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3Mjc2MDg2MTQsImlzcyI6InBhdGNocGlsb3QiLCJzdWIiOiJoYWJpY2h0c3dhbGQiLCJyb2xlIjp7ImlkIjoxLCJuYW1lIjoiYWRtaW4ifX0.i_1iNqdgaIcBa9cuUQnvqNR6lKZMEWpBwg5lh2SxffQ" \
        -H "Content-Type: application/json" \
        -d '{
              "version": "'"$version"'",
              "app_id": 4,
              "instruction": "have a good thyme",
              "relies_on_version": "current"
            }'
    - echo "Version information sent successfully!"


